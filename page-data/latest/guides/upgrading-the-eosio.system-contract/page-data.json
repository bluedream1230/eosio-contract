{"componentChunkName":"component---src-page-templates-content-page-jsx","path":"/latest/guides/upgrading-the-eosio.system-contract","webpackCompilationHash":"f8f2f30ffe9264858db3","result":{"data":{"site":{"pathPrefix":"/eosio.contracts"},"allMarkdownRemark":{"nodes":[{"fields":{"slug":"/latest/build-and-deploy"}},{"fields":{"slug":"/latest/guides/how-to-buy-ram"}},{"fields":{"slug":"/latest/guides/how-to-sign-a-multisig-transaction-with-eosio.msig"}},{"fields":{"slug":"/latest/guides/how-to-create-issue-and-transfer-a-token"}},{"fields":{"slug":"/latest/guides/how-to-stake"}},{"fields":{"slug":"/latest/guides/how-to-vote"}},{"fields":{"slug":"/latest/action-reference/eosio.bios/index"}},{"fields":{"slug":"/latest/action-reference/eosio.msig/index"}},{"fields":{"slug":"/latest/action-reference/eosio.system/exchange_state"}},{"fields":{"slug":"/latest/action-reference/eosio.system/native"}},{"fields":{"slug":"/latest/action-reference/eosio.system/rex.results"}},{"fields":{"slug":"/latest/action-reference/eosio.token/index"}},{"fields":{"slug":"/latest/action-reference/eosio.wrap/index"}},{"fields":{"slug":"/latest/guides/upgrading-the-eosio.system-contract"}},{"fields":{"slug":"/latest/action-reference/eosio.system/index"}},{"fields":{"slug":"/latest/index"}},{"fields":{"slug":"/latest/guides/how-to-use-eosio.wrap"}}]},"markdownRemark":{"html":"<h2 id=\"upgrading-the-system-contract\">Upgrading the system contract</h2>\n<h3 id=\"indirect-method-using-eosiomsig-contract\">Indirect method using eosio.msig contract</h3>\n<p>Cleos currently provides tools to propose an action with the eosio.msig contract, but it does not provide an easy interface to propose a custom transaction.</p>\n<p>So, at the moment it is difficult to propose an atomic transaction with multiple actions (for example <code class=\"language-text\">eosio::setcode</code> followed by <code class=\"language-text\">eosio::setabi</code>).</p>\n<p>The advantage of the eosio.msig method is that it makes coordination much easier and does not place strict time limits (less than 9 hours) on signature collection.</p>\n<p>The disadvantage of the eosio.msig method is that it requires the proposer to have sufficient RAM to propose the transaction and currently cleos does not provide convenient tools to use it with custom transactions like the one that would be necessary to atomically upgrade the system contract.</p>\n<p>For now, it is recommended to use the direct method to upgrade the system contract.</p>\n<h3 id=\"direct-method-avoids-using-eosiomsig-contract\">Direct method (avoids using eosio.msig contract)</h3>\n<p>Each of the top 21 block producers should do the following:</p>\n<ol>\n<li>Get current system contract for later comparison (actual hash and ABI on the main-net blockchain will be different):</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ cleos get code -c original_system_contract.wast -a original_system_contract.abi eosio\ncode hash: cc0ffc30150a07c487d8247a484ce1caf9c95779521d8c230040c2cb0e2a3a60\nsaving wast to original_system_contract.wast\nsaving abi to original_system_contract.abi</code></pre></div>\n<ol start=\"2\">\n<li>Generate the unsigned transaction which upgrades the system contract:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ cleos set contract -s -j -d eosio contracts/eosio.system | tail -n +4 &gt; upgrade_system_contract_trx.json</code></pre></div>\n<p>The first few lines of the generated file should be something similar to (except with very different numbers for <code class=\"language-text\">expiration</code>, <code class=\"language-text\">ref_block_num</code>, and <code class=\"language-text\">ref_block_prefix</code>):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n   &quot;expiration&quot;: &quot;2018-06-15T22:17:10&quot;,\n   &quot;ref_block_num&quot;: 4552,\n   &quot;ref_block_prefix&quot;: 511016679,\n   &quot;max_net_usage_words&quot;: 0,\n   &quot;max_cpu_usage_ms&quot;: 0,\n   &quot;delay_sec&quot;: 0,\n   &quot;context_free_actions&quot;: [],\n   &quot;actions&quot;: [{\n      &quot;account&quot;: &quot;eosio&quot;,\n      &quot;name&quot;: &quot;setcode&quot;,\n      &quot;authorization&quot;: [{\n          &quot;actor&quot;: &quot;eosio&quot;,\n          &quot;permission&quot;: &quot;active&quot;\n        }\n      ],</code></pre></div>\n<p>and the last few lines should be:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">      }\n   ],\n   &quot;transaction_extensions&quot;: [],\n   &quot;signatures&quot;: [],\n   &quot;context_free_data&quot;: []\n}</code></pre></div>\n<p>One of the top block producers should be chosen to lead the upgrade process. This lead producer should take their generated <code class=\"language-text\">upgrade_system_contract_trx.json</code>, rename it to <code class=\"language-text\">upgrade_system_contract_official_trx.json</code>, and do the following:</p>\n<ol start=\"3\">\n<li>\n<p>Modify the <code class=\"language-text\">expiration</code> timestamp in <code class=\"language-text\">upgrade_system_contract_official_trx.json</code> to a time that is sufficiently far in the future to give enough time to collect all the necessary signatures, but not more than 9 hours from the time the transaction was generated. Also, keep in mind that the transaction will not be accepted into the blockchain if the expiration is more than 1 hour from the present time.</p>\n</li>\n<li>\n<p>Pass the <code class=\"language-text\">upgrade_system_contract_official_trx.json</code> file to all the other top 21 block producers.</p>\n</li>\n</ol>\n<p>Then each of the top 21 block producers should do the following:</p>\n<ol start=\"5\">\n<li>Compare their generated <code class=\"language-text\">upgrade_system_contract_official_trx.json</code> file with the <code class=\"language-text\">upgrade_system_contract_official_trx.json</code> provided by the lead producer. The only difference should be in <code class=\"language-text\">expiration</code>, <code class=\"language-text\">ref_block_num</code>, <code class=\"language-text\">ref_block_prefix</code>, for example:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ diff upgrade_system_contract_official_trx.json upgrade_system_contract_trx.json\n2,4c2,4\n&lt;   &quot;expiration&quot;: &quot;2018-06-15T22:17:10&quot;,\n&lt;   &quot;ref_block_num&quot;: 4552,\n&lt;   &quot;ref_block_prefix&quot;: 511016679,\n---\n&gt;   &quot;expiration&quot;: &quot;2018-06-15T21:20:39&quot;,\n&gt;   &quot;ref_block_num&quot;: 4972,\n&gt;   &quot;ref_block_prefix&quot;: 195390844,</code></pre></div>\n<ol start=\"6\">\n<li>If the comparison is good, each block producer should proceed with signing the official upgrade transaction with the keys necessary to satisfy their active permission. If the block producer only has a single key (i.e the \"active key\") in the active permission of their block producing account, then they only need to generate one signature using that active key. This signing process can be done offline for extra security.</li>\n</ol>\n<p>First, the block producer should collect all the necessary information. Let us assume that the block producers active key pair is <code class=\"language-text\">(EOS5kBmh5kfo6c6pwB8j77vrznoAaygzoYvBsgLyMMmQ9B6j83i9c, 5JjpkhxAmEfynDgSn7gmEKEVcBqJTtu6HiQFf4AVgGv5A89LfG3)</code>. The block producer needs their active private key (<code class=\"language-text\">5JjpkhxAmEfynDgSn7gmEKEVcBqJTtu6HiQFf4AVgGv5A89LfG3</code> in this example), the <code class=\"language-text\">upgrade_system_contract_official_trx.json</code>, and the <code class=\"language-text\">chain_id</code> (<code class=\"language-text\">d0242fb30b71b82df9966d10ff6d09e4f5eb6be7ba85fd78f796937f1959315e</code> in this example) which can be retrieved through <code class=\"language-text\">cleos get info</code>.</p>\n<p>Then on a secure computer the producer can sign the transaction (the producer will need to paste in their private key when prompted):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ cleos sign --chain-id d0242fb30b71b82df9966d10ff6d09e4f5eb6be7ba85fd78f796937f1959315e upgrade_system_contract_trx.json | tail -n 5\nprivate key:   &quot;signatures&quot;: [\n    &quot;SIG_K1_JzABB9gzDGwUHaRmox68UNcfxMVwMnEXqqS1MvtsyUX8KGTbsZ5aZQZjHD5vREQa5BkZ7ft8CceLBLAj8eZ5erZb9cHuy5&quot;\n  ],\n  &quot;context_free_data&quot;: []\n}</code></pre></div>\n<p>Make sure to use the <code class=\"language-text\">chain_id</code> of the actual main-net blockchain that the transaction will be submitted to and not the example <code class=\"language-text\">chain_id</code> provided above.</p>\n<p>The output should include the signature (in this case <code class=\"language-text\">&quot;SIG_K1_JzABB9gzDGwUHaRmox68UNcfxMVwMnEXqqS1MvtsyUX8KGTbsZ5aZQZjHD5vREQa5BkZ7ft8CceLBLAj8eZ5erZb9cHuy5&quot;</code>) which the producer should then send to the lead producer.</p>\n<p>When the lead producer collects 15 producer signatures, the lead producer should do the following:</p>\n<ol start=\"7\">\n<li>Make a copy of the <code class=\"language-text\">upgrade_system_contract_official_trx.json</code> and call it <code class=\"language-text\">upgrade_system_contract_official_trx_signed.json</code>, and then modify the <code class=\"language-text\">upgrade_system_contract_official_trx_signed.json</code> so that the <code class=\"language-text\">signatures</code> field includes all 15 collected signatures. So the tail end of <code class=\"language-text\">upgrade_system_contract_official_trx_signed.json</code> could look something like:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ cat upgrade_system_contract_official_trx_signed.json | tail -n 20\n  &quot;transaction_extensions&quot;: [],\n  &quot;signatures&quot;: [\n   &quot;SIG_K1_JzABB9gzDGwUHaRmox68UNcfxMVwMnEXqqS1MvtsyUX8KGTbsZ5aZQZjHD5vREQa5BkZ7ft8CceLBLAj8eZ5erZb9cHuy5&quot;,\n   &quot;SIG_K1_Kj7XJxnPQSxEXZhMA8uK3Q1zAxp7AExzsRd7Xaa7ywcE4iUrhbVA3B6GWre5Ctgikb4q4CeU6Bvv5qmh9uJjqKEbbjd3sX&quot;,\n   &quot;SIG_K1_KbE7qyz3A9LoQPYWzo4e6kg5ZVojQVAkDKuufUN2EwVUqtFhtjmGoC6QPQqLi8J7ftiysBp52wJBPjtNQUfZiGpGMsnZ1f&quot;,\n   &quot;SIG_K1_KdQsE7ahHA9swE9SDGg4oF6XahpgHmZfEgQAy9KPBLd9HuwrF6c8m6jz43zizK2oo32Ejg1DYuMfoEvJgVfXo81jsqTHvA&quot;,\n   &quot;SIG_K1_K6228Hi2z1WabgVdf5bk2UdKyyDSVFwkMaagTn9oLVDV8rCX7aQcjY94c39ah2CkLTsTEqzTPAYknJ8m2m9B7npPkHaFzc&quot;,\n   &quot;SIG_K1_Jzdx75hBCA2WSaXgrupmrNbcQocUCsP8r1BKkPXMreiAKPZDwX9J3G8fS1HhyqWjc7FbukwZf8sVRdS3wKbJVpytqXe7Nn&quot;,\n   &quot;SIG_K1_KW7Qu2SdPD3zuQKh2ziFLzn9QbKqeMpeiemULky5Bbg1Mst6ijbCX3k2AVFGNFLkNLA36PM1WAT5oipzu1B1K7ymRxTx1Z&quot;,\n   &quot;SIG_K1_KXJf1KZNpz73YFKKE7u6jFgsQ8XcX3yA7rDX6ZmG1Qfnc9FLLmT1WViv4bwcPbxaEYfR6SNWfk5cCR9eao2si1soqkXq92&quot;,\n   &quot;SIG_K1_JynjkHFT5UFGDpEcqdriXTzCGCwS36Xztq4UAWQHLQgRUZT2YFoLhUcc87kvUteqCUGVxsmSbfgWv1KLy24voKN4Qs5zTe&quot;,\n   &quot;SIG_K1_JxhfCaGBhuNShpDHn7j1CryG3iSebvfi7FUnJsfkXNTiwLyq2NDBkeakwjCMWFbzr6qqWuMDLjfXbzdtU17f1wCXMjKSgk&quot;,\n   &quot;SIG_K1_KcMSz89QG1ZRFNrXc69R63d5KXbJA8CBjNPYv1VEA3TRfjqVYuhyaHpGXQN4RSKDq4ygr3UTRYBQQVutkJnR6zZ4Ssgd7R&quot;,\n   &quot;SIG_K1_JuxT6bhUAbDs6Q2ppuKyKauduvbaJLxvh4gBH4e4A9yRhvUBT7w3DcvMyhdaor27Kbu29jnqhTbvXcb57QqKWQDpboLv7e&quot;,\n   &quot;SIG_K1_K8BuFYpCiC5FhpVK8ZAzc3VUg7vz6WwLoWBrGN6nnuqUjngGqvHp3UxDVzcwhqccHdv8kdPXvF6G1NszwF1dd3wjCrHBYw&quot;,\n   &quot;SIG_K1_KfH5ZirPwDk1RQKvJv2AGPfsJyPXvXLegZ7LvcPmRtjtMiErs1STXLNT8kiBfhZr4xkWRA5NR1kMF3d49DFMJiB2iWMXJc&quot;,\n   &quot;SIG_K1_KjJB8jtcqpVe3r5jouFiAa9wJeYqoLMh5xrUV6kBF6UWfbYjimMWBJWz2ZPomGDsk7JtdUESVrYj1AhYbdp3X48KLm5Cev&quot;\n  ],\n  &quot;context_free_data&quot;: []\n}</code></pre></div>\n<ol start=\"8\">\n<li>Push the signed transaction to the blockchain:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ cleos push transaction --skip-sign upgrade_system_contract_official_trx_signed.json\n{\n  &quot;transaction_id&quot;: &quot;202888b32e7a0f9de1b8483befac8118188c786380f6e62ced445f93fb2b1041&quot;,\n  &quot;processed&quot;: {\n    &quot;id&quot;: &quot;202888b32e7a0f9de1b8483befac8118188c786380f6e62ced445f93fb2b1041&quot;,\n    &quot;receipt&quot;: {\n      &quot;status&quot;: &quot;executed&quot;,\n      &quot;cpu_usage_us&quot;: 4909,\n      &quot;net_usage_words&quot;: 15124\n    },\n    &quot;elapsed&quot;: 4909,\n    &quot;net_usage&quot;: 120992,\n    &quot;scheduled&quot;: false,\n    &quot;action_traces&quot;: [{\n...</code></pre></div>\n<p>If you get an error message like the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Error 3090003: provided keys, permissions, and delays do not satisfy declared authorizations\nEnsure that you have the related private keys inside your wallet and your wallet is unlocked.</code></pre></div>\n<p>That means that at least one of the signatures provided were bad. This may be because a producer signed the wrong transaction, used the wrong private key, or used the wrong chain ID.</p>\n<p>If you get an error message like the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Error 3090002: irrelevant signature included\nPlease remove the unnecessary signature from your transaction!</code></pre></div>\n<p>That means unnecessary signatures were included. If there are 21 active producers, only signatures from exactly 15 of those 21 active producers are needed.</p>\n<p>If you get an error message like the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Error 3040006: Transaction Expiration Too Far\nPlease decrease the expiration time of your transaction!</code></pre></div>\n<p>That means that the expiration time is more than 1 hour in the future and you need to wait some time before being allowed to push the transaction.</p>\n<p>If you get an error message like the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Error 3040005: Expired Transaction\nPlease increase the expiration time of your transaction!</code></pre></div>\n<p>That means the expiration time of the signed transaction has passed and this entire process has to restart from step 1.</p>\n<ol start=\"9\">\n<li>Assuming the transaction successfully executes, everyone can then verify that the new contract is in place:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ cleos get code -c new_system_contract.wast -a new_system_contract.abi eosio\ncode hash: 9fd195bc5a26d3cd82ae76b70bb71d8ce83dcfeb0e5e27e4e740998fdb7b98f8\nsaving wast to new_system_contract.wast\nsaving abi to new_system_contract.abi\n$ diff original_system_contract.abi new_system_contract.abi\n584,592d583\n&lt;         },{\n&lt;           &quot;name&quot;: &quot;deferred_trx_id&quot;,\n&lt;           &quot;type&quot;: &quot;uint32&quot;\n&lt;         },{\n&lt;           &quot;name&quot;: &quot;last_unstake_time&quot;,\n&lt;           &quot;type&quot;: &quot;time_point_sec&quot;\n&lt;         },{\n&lt;           &quot;name&quot;: &quot;unstaking&quot;,\n&lt;           &quot;type&quot;: &quot;asset&quot;</code></pre></div>","tableOfContents":"<ul>\n<li>\n<p><a href=\"/eosio.contracts/latest/guides/upgrading-the-eosio.system-contract/#upgrading-the-system-contract\">Upgrading the system contract</a></p>\n<ul>\n<li><a href=\"/eosio.contracts/latest/guides/upgrading-the-eosio.system-contract/#indirect-method-using-eosiomsig-contract\">Indirect method using eosio.msig contract</a></li>\n<li><a href=\"/eosio.contracts/latest/guides/upgrading-the-eosio.system-contract/#direct-method-avoids-using-eosiomsig-contract\">Direct method (avoids using eosio.msig contract)</a></li>\n</ul>\n</li>\n</ul>","frontmatter":{"edit_link":null,"request_changes_link":null},"fields":{"articleTitle":"guidesupgrading-the-eosiosystem-contract","contentTitle":"Upgrading The Eosio.system Contract","headTagTitle":"guidesupgrading-the-eosiosystem-contract","internalSummary":"/usr/local/lib/python3.7/site-packages/thorka-0.1-py3.7.egg/src/lib/gatsby/data/latest/SUMMARY.json","isCollection":false,"isRoot":true,"isTagged":true,"organization":"EOSIO","originalKey":"/","pathData":"{\"tagged\":true,\"parentPath\":\"latest/guides\",\"collectionPath\":\"/\",\"rootDirPath\":\"latest\",\"filename\":\"upgrading-the-eosio.system-contract.md\"}","repository":"eosio.contracts","showSearch":true,"slug":"/latest/guides/upgrading-the-eosio.system-contract","tagsList":"[{\"beta\":false,\"build\":false,\"deprecated\":false,\"latest\":true,\"rc\":false,\"tag\":\"v1.8.0\",\"tag_reduced\":\"1.8\",\"tag_reduced_friendly\":\"v1.8\",\"tag_sanitized\":\"1.8.0\",\"summaryPath\":\"/usr/local/lib/python3.7/site-packages/thorka-0.1-py3.7.egg/src/lib/gatsby/data/latest/SUMMARY.json\",\"importedSummary\":\"N/A\",\"version\":\"latest\"}]","latestDDVersion":"latest","importedSummary":"N/A","hasPrimaryNavigation":false,"primaryNavData":"[{\"text\":\"NONE\",\"path\":\"EMPTY\"}]","currentVersion":"latest","currentDDVersion":"1.8","summaryJson":"{\"array\":[{\"title\":\"Build And Deploy\",\"link\":\"build-and-deploy.md\"},{\"sub\":[{\"title\":\"Upgrading The Eosio.system Contract\",\"link\":\"guides/upgrading-the-eosio.system-contract.md\"},{\"title\":\"How To Buy Ram\",\"link\":\"guides/how-to-buy-ram.md\"},{\"title\":\"How To Stake\",\"link\":\"guides/how-to-stake.md\"},{\"title\":\"How To Vote\",\"link\":\"guides/how-to-vote.md\"},{\"title\":\"How To Create Issue And Transfer A Token\",\"link\":\"guides/how-to-create-issue-and-transfer-a-token.md\"},{\"title\":\"How To Sign A Multisig Transaction With Eosio.msig\",\"link\":\"guides/how-to-sign-a-multisig-transaction-with-eosio.msig.md\"},{\"title\":\"How To Use Eosio.wrap\",\"link\":\"guides/how-to-use-eosio.wrap.md\"}],\"title\":\"Guides\"},{\"sub\":[{\"sub\":[],\"title\":\"eosio.bios\",\"link\":\"action-reference/eosio.bios\"},{\"sub\":[],\"title\":\"eosio.msig\",\"link\":\"action-reference/eosio.msig\"},{\"sub\":[{\"title\":\"native\",\"link\":\"action-reference/eosio.system/native.md\"},{\"title\":\"rex.results\",\"link\":\"action-reference/eosio.system/rex.results.md\"}],\"title\":\"eosio.system\",\"link\":\"action-reference/eosio.system\"},{\"sub\":[],\"title\":\"eosio.token\",\"link\":\"action-reference/eosio.token\"},{\"sub\":[],\"title\":\"eosio.wrap\",\"link\":\"action-reference/eosio.wrap\"}],\"title\":\"Action Reference\"}],\"title\":[]}"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/latest/guides/upgrading-the-eosio.system-contract"}}}